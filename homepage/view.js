/**
 * 笔记起始页（Homepage）
 * 作者: 稻米鼠
 * 网站: https://zji.me/
 * 支持: https://afdian.com/a/daomishu
 * 仓库: https://github.com/dmscode/DMS-Dataview-Views
 * 创建时间: 2024-10-06
 * 生成时间: 2025-03-02
 * 一个简单的主页，用于展示个人信息和项目列表。
 */
"use strict";(()=>{var P=Object.defineProperty;var o=(f,t)=>P(f,"name",{value:t,configurable:!0});var S=class S{constructor(t){this.card=document.createElement(t.link?"a":"div"),this.setData(t),this.addCardBox(t.position)}setData(t){this.setClassName(t.className||[]),this.card.dataset.width=String(t.width||12),t.link&&this.setLink(t.link),t.progress!==void 0&&this.setProgress(t.progress),t.status&&(this.card.dataset.status=t.status),t.icon&&this.setIcon(t.icon),t.text&&this.setText(t.text),t.value!==void 0&&this.setValue(t.value),t.tip!==void 0&&this.setTip(t.tip)}setClassName(t=[]){this.card.className="card-box",this.card.classList.add(...t)}setProgress(t){(t===void 0||isNaN(t)||t<0)&&(t=0),t=Math.min(t,100);let e=this.card.querySelector("div.card-box-progress");e||(e=document.createElement("div"),e.classList.add("card-box-progress"),this.card.prepend(e));let s=[[90,"red+"],[80,"red"],[60,"orange"],[40,"yellow"],[20,"blue"],[0,"green"],[-10,"gray"]];for(let[i,a]of s)if(t>=i){this.card.dataset.status=a;break}e.style.width=`${t}%`}setIcon(t){t=t||"";let e=/^https?:/i.test(t)||/\.(jpg|jpeg|gif|png|bmp|bmap|webp|svg|tiff)$/i.test(t),s=this.card.querySelector("span.card-box-icon");if(!s){s=document.createElement("span"),s.classList.add("card-box-icon");let a=this.card.querySelector("div.card-box-progress");a?a.after(s):this.card.append(s)}if(!e){s.textContent=t;return}s.textContent="";let i=document.createElement("img");i.classList.add("card-box-icon-img"),i.src=t,s.append(i)}setText(t){t=t||"";let e=this.card.querySelector("span.card-box-content");if(!e){e=document.createElement("span"),e.classList.add("card-box-content");let s=this.card.querySelector("span.card-box-tip");s?s.before(e):this.card.append(e)}e.textContent=t}setTip(t){let e=this.card.querySelector("span.card-box-tip");if(t===void 0){e&&e.remove();return}e||(e=document.createElement("span"),e.classList.add("card-box-tip"),this.card.append(e)),/<(\/\w+|\w+|\w+\s*\/)>/.test(t)?e.innerHTML=t:e.textContent=t}setValue(t){this.card.dataset.value=t===void 0?"":String(t)}setLink(t){this.card.tagName!=="A"&&this.changeTagToA(),this.card=this.card,this.card.classList.add("card-link","internal-link"),this.card.href=t,this.card.target="_blank",this.card.rel="noopener"}changeTagToA(){if(this.card.tagName!=="A"){let t=document.createElement("a");for(let e of this.card.attributes)t.setAttribute(e.name,e.value);for(;this.card.firstChild;)t.append(this.card.firstChild);this.card.parentNode?.replaceChild(t,this.card),this.card=t}}addCardBox(t){let{parent:e,before:s,after:i}=t||{},a=e||dv.container;s?s.before(this.card):i?i.after(this.card):a.append(this.card)}};o(S,"CardBox");var c=S,$=class $ extends c{constructor(t){super(Object.assign({className:["load-card"],text:"Loading..."},t))}remove(){this.card.remove()}};o($,"LoadingCard");var l=$;var E=class E extends c{constructor(t){t.className=["card-box-header",`card-box-header-${t.level||3}`,...t.className||[]],super(t)}};o(E,"Header");var x=E;var B=class B extends c{constructor(t){t.className=["year-progress",...t.className||[]];let{precision:e=2,barLength:s=20}=t,i=new Date,a=new Date(i.getFullYear(),0,1),r=new Date(i.getFullYear()+1,0,1),n=+((i.getTime()-a.getTime())/(r.getTime()-a.getTime())*100).toFixed(e);Object.assign(t,{progress:n,text:"Year Progress",value:`${Math.round(n)}%`,icon:"\u23F3",tip:`${n}%`}),super(t),this.card.onclick=()=>{let g=Math.round(n/(100/s)),d=`Year Progress: ${"".padEnd(g,"\u2593")}${"".padEnd(s-g,"\u2591")} ${n}%`;navigator.clipboard.writeText(d),new Notice(d)}}};o(B,"YearProgress");var C=B;var y=o(async f=>{let t=f.path||dv.current()?.file.path,e=f.separator&&f.separator.length?f.separator:["|",":",","],s=new RegExp(`[${e.join("")}]`,"g"),i=f.sections||[],a=app.vault.getFileByPath(t);if(!a)return[];let r=await app.vault.cachedRead(a),n=[],g="";return r.split(/\r?\n/g).forEach(d=>{let u=d.match(/^#+\s+(.*)/);if(u){g=u[1];return}if(!g||i.length&&!i.includes(g))return;let h=/^\s*([-+*|]|\d+\.) /;if(!h.test(d))return;let p=d.match(/^\s*[-+*|] \[(.)\] /);p&&(d=d.replace(p[0],""));let m=d.replace(h,"").split(s).map(w=>w.trim());p&&m.unshift(p[1]),m.push(g),n.push(m)}),n},"getDataFromFile");var N=class N{constructor(t){this.data=[];this.dataToShow={};(!t.settings||typeof t.settings!="object")&&(t.settings={}),this.config=t,this.loadingCard=new l({width:t.width||3}),this.initialize()}async initialize(){await this.getData(),this.processData(),this.showData(),this.endLoading()}async getData(){let{path:t,separator:e}=this.config;this.data=await y({path:t,sections:Object.keys(this.config.settings),separator:e})}getItemSetting(t,e,s=void 0){return this.config.settings[t][e]||this.config[e]||s}processData(){let t=new Date,e={};this.data.forEach(s=>{let[i,a,...r]=s,n=s[s.length-1];if(this.config.settings[n]){if(e[n]){if(!e[n].perDayComputed){let g=e[n],d=Math.floor((new Date(g.date).getTime()-new Date(i).getTime())/864e5),u=+(new Function("return "+a)()-+new Function("return "+g.money.replace(/\+[\d.]+$/,""))()).toFixed(2);g.perDayComputed=(u/d).toFixed(2)}return}e[n]={date:i,money:a,section:n}}}),Object.values(e).forEach(({date:s,money:i,perDayComputed:a,section:r})=>{let n=Math.floor((t.getTime()-new Date(s).getTime())/864e5),g=i?+new Function("return "+i)():0,d=a||this.config.settings[r].perDay,u=d?Math.floor(g/+d):"\u672A\u77E5",h=u!=="\u672A\u77E5"?+u-n:"\u672A\u77E5",p=h!=="\u672A\u77E5"&&d?(g-+(n*+d)).toFixed(2):"\u672A\u77E5",m=h!=="\u672A\u77E5"?+(Math.max(1-Number(p)/(this.getItemSetting(r,"warningBalcance",0)*3),1-h/(this.config.warningDays||60))*100).toFixed(2):100,w=this.getItemSetting(r,"currency","\u5143");this.dataToShow[r]={className:["card-box-payment"],link:(this.config.path||"")+`#${r}`,progress:m,icon:this.getItemSetting(r,"icon"),text:this.config.settings[r].title||r,width:this.getItemSetting(r,"width",3),position:{before:this.loadingCard.card},tip:`${n} \u5929\u524D ${g} ${w}<br>`+(a?`\u6BCF\u65E5\u6D88\u8017\uFF08\u4F30\u7B97\uFF09\uFF1A${a} ${w}<br>`:"")+`\u9884\u8BA1\u53EF\u7528\uFF1A${h} \u5929<br>\u9884\u4F30\u4F59\u989D\uFF1A${p} ${w}<br>`}})}showData(){Object.keys(this.dataToShow).forEach(t=>{new c(this.dataToShow[t])})}endLoading(){this.loadingCard.remove()}};o(N,"Payment");var b=N;var M=class M{constructor(t){if(!t.items)this.linkHandler(t),new c(t);else{let e=new l({width:t.width||3});t.items.forEach(s=>{s=this.linkHandler({...t,...s,position:{before:e.card}}),new c(s)}),e.remove()}}linkHandler(t){return this.setLink(t),this.setTip(t),this.setStatus(t),t}setLink(t){if(!t.link)return;if(t.fallback&&!app.vault.getFileByPath(t.link)&&(t.link=t.fallback),/^obsidian:\/\//i.test(t.link)){this.setStatus(t,"blue"),this.setIcon(t,"\u2699\uFE0F");return}if(/^https?:\/\//i.test(t.link)){this.setStatus(t,"green"),this.setIcon(t,"\u{1F310}");return}else if(app.vault.getFileByPath(t.link))this.setIcon(t,"\u{1F4C4}");else{this.setStatus(t,"yellow"),this.setIcon(t,"\u{1F4DD}");return}}setStatus(t,e=void 0){!t.status&&e&&(t.status=e),t.status&&(t.progress=100)}setIcon(t,e){t.icon||(t.icon=e)}setTip(t){t.tip||(t.tip=t.link)}};o(M,"Link");var D=M;var F=class F{constructor(t){this.data=[];this.dataToShow=[];(!t.settings||typeof t.settings!="object")&&(t.settings={}),this.config=t,this.loadingCard=new l({width:t.width||3}),this.initialize()}async initialize(){await this.getData(),this.processData(),this.showData(),this.endLoading()}async getData(){let{path:t,separator:e}=this.config;this.data=await y({path:t,sections:Object.keys(this.config.settings),separator:e})}getItemSetting(t,e,s=void 0){return this.config.settings[t][e]||this.config[e]||s}processData(){this.data.forEach(t=>{let[e,s,i,a,r,n,g,d,...u]=t,h=t[t.length-1];if(!this.config.settings||!this.config.settings[h])return;i&&(r&&!a?a=Math.floor((new Date(r).getTime()-new Date(i).getTime())/864e5).toString():!r&&a&&(r=window.moment((new Date(i).getTime()+Number(a)*864e5)/1e3).format("YYYY-MM-DD")));let p={className:["card-box-inventory"],link:(this.config.path||"")+`#${h}`,icon:this.getItemSetting(h,"icon","\u{1F4E6}"),text:s,width:this.getItemSetting(h,"width",3),position:{before:this.loadingCard.card},tip:(i?`\u751F\u4EA7\u65E5\u671F\uFF1A${i}<br>`:"")+(a?`\u4FDD\u8D28\u671F\uFF1A${a}\u5929<br>`:"")+(r?`\u8FC7\u671F\u65E5\u671F\uFF1A${r}<br>`:"")+(n?`\u6570\u91CF\uFF1A${n}${g||""}<br>`:"")+(d?`\u5907\u6CE8\uFF1A${d}<br>`:"")};if(i&&a&&r){let m=Math.floor((new Date().getTime()-new Date(i).getTime())/864e5);p.value=+a-m,p.progress=m/+a*100;let w=this.getItemSetting(h,"warningDays",0);w&&p.value<=w&&(p.status="red+")}this.dataToShow.push(p)})}showData(){this.dataToShow.forEach(t=>{new c(t)})}endLoading(){this.loadingCard.remove()}};o(F,"Inventory");var T=F;var I=class I extends c{constructor(t){t.className=["data-shower",...t.className||[]],t.dataName=t.dataName?`${t.dataName}: `:"",super(Object.assign({className:["load-card"],text:t.dataName+"Data is loading..."},t)),this.getData(t)}async getData(t){try{let s=await(await fetch(t.dataSource)).json(),i=t.dataPath.reduce((a,r)=>a[r]||a,s);this.setText(t.dataName+i)}catch(e){console.error(t.dataName+"Error fetching data:",e),this.setText(t.dataName+"Error fetching data")}}};o(I,"DataShower");var v=I;var W=class W{constructor(t){if(this.config=t,!this.config.items)new c(this.processData(this.config));else{let e=new l({width:t.width||3});this.config.items.forEach(s=>{s=this.processData(s),new c(s)}),e.remove()}}processData(t){let{date:e,totalDays:s}=t,i=Math.floor((new Date().getTime()-new Date(e).getTime())/864e5),a=Math.abs(i);return t.value=a,s&&(t.progress=+((s-a)/s*100).toFixed(2)),t.icon=t.icon||this.config.icon||" ",t.width=t.width||this.config.width||3,i<0?(t.tip=`\u8DDD\u79BB ${t.text}<br>\uFF08${t.date}\uFF09<br> \u8FD8\u6709 ${a} \u5929`,t.text=`${t.text} >>>`):i>0?(t.tip=` ${t.text}<br>\uFF08${t.date}\uFF09<br> \u5DF2\u7ECF\u8FC7\u53BB\u4E86 ${a} \u5929`,t.text=`<<< ${t.text}`):(t.tip=`\u4ECA\u5929\u5C31\u662F<br>${t.text}<br>\uFF08${t.date}\uFF09`,t.progress=100,t.status="red",t.value=void 0),t}};o(W,"CountDays");var k=W;var H={Header:x,YearProgress:C,Payment:b,Link:D,Inventory:T,DataShower:v,CountDays:k},j=class j{constructor(t){if(t.type=t.type||"no type",!Object.keys(H).includes(t.type)){new H.Header({text:`\u672A\u627E\u5230\u6302\u4EF6 ${t.type}`});return}new H[t.type](t)}};o(j,"Widget");var L=j;dv.container.classList.add("homepage-container");input.forEach(f=>{new L(f)});})();
