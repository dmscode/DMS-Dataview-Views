/**
 * 笔记起始页（Homepage）
 * 作者: 稻米鼠
 * 网站: https://zji.me/
 * 支持: https://afdian.com/a/daomishu
 * 仓库: https://github.com/dmscode/DMS-Dataview-Views
 * 创建时间: 2024-10-06
 * 生成时间: 2025-04-09
 * 一个简单的主页，用于展示个人信息和项目列表。
 */
"use strict";(()=>{var A=Object.defineProperty;var o=(u,t)=>A(u,"name",{value:t,configurable:!0});var L=class L{constructor(t){this.card=document.createElement(t.link?"a":"div"),this.setData(t),this.addCardBox(t.position)}setData(t){this.setClassName(t.className||[]),this.card.dataset.width=String(t.width||12),t.link&&this.setLink(t.link),t.progress!==void 0&&this.setProgress(t.progress),t.status&&(this.card.dataset.status=t.status),t.icon&&this.setIcon(t.icon),t.text&&this.setText(t.text),t.value!==void 0&&this.setValue(t.value),t.tip!==void 0&&this.setTip(t.tip)}setClassName(t=[]){this.card.className="card-box",this.card.classList.add(...t)}setProgress(t){(t===void 0||isNaN(t)||t<0)&&(t=0),t=Math.min(t,100);let e=this.card.querySelector("div.card-box-progress");e||(e=document.createElement("div"),e.classList.add("card-box-progress"),this.card.prepend(e));let a=[[90,"red+"],[80,"red"],[60,"orange"],[40,"yellow"],[20,"blue"],[0,"green"],[-10,"gray"]];for(let[r,s]of a)if(t>=r){this.card.dataset.status=s;break}e.style.width=`${t}%`}setIcon(t){t=t||"";let e=/^https?:/i.test(t)||/\.(jpg|jpeg|gif|png|bmp|bmap|webp|svg|tiff)$/i.test(t),a=this.card.querySelector("span.card-box-icon");if(!a){a=document.createElement("span"),a.classList.add("card-box-icon");let s=this.card.querySelector("div.card-box-progress");s?s.after(a):this.card.append(a)}if(!e){a.textContent=t;return}a.textContent="";let r=document.createElement("img");r.classList.add("card-box-icon-img"),r.src=t,a.append(r)}setText(t){t=t||"";let e=this.card.querySelector("span.card-box-content");if(!e){e=document.createElement("span"),e.classList.add("card-box-content");let a=this.card.querySelector("span.card-box-tip");a?a.before(e):this.card.append(e)}e.textContent=t}setTip(t){let e=this.card.querySelector("span.card-box-tip");if(t===void 0){e&&e.remove();return}e||(e=document.createElement("span"),e.classList.add("card-box-tip"),this.card.append(e)),/<(\/\w+|\w+|\w+\s*\/)>/.test(t)?e.innerHTML=t:e.textContent=t}setValue(t){this.card.dataset.value=t===void 0?"":String(t)}setLink(t){this.card.tagName!=="A"&&this.changeTagToA(),this.card=this.card,this.card.classList.add("card-link","internal-link"),this.card.href=t,this.card.target="_blank",this.card.rel="noopener"}changeTagToA(){if(this.card.tagName!=="A"){let t=document.createElement("a");for(let e of this.card.attributes)t.setAttribute(e.name,e.value);for(;this.card.firstChild;)t.append(this.card.firstChild);this.card.parentNode?.replaceChild(t,this.card),this.card=t}}addCardBox(t){let{parent:e,before:a,after:r}=t||{},s=e||dv.container;a?a.before(this.card):r?r.after(this.card):s.append(this.card)}};o(L,"CardBox");var c=L,N=class N extends c{constructor(t){super(Object.assign({className:["load-card"],text:"Loading..."},t))}remove(){this.card.remove()}};o(N,"LoadingCard");var l=N;var E=class E extends c{constructor(t){t.className=["card-box-header",`card-box-header-${t.level||3}`,...t.className||[]],super(t)}};o(E,"Header");var y=E;var B=class B extends c{constructor(t){t.className=["year-progress",...t.className||[]];let{precision:e=2,barLength:a=20}=t,r=new Date,s=new Date(r.getFullYear(),0,1),i=new Date(r.getFullYear()+1,0,1),n=+((r.getTime()-s.getTime())/(i.getTime()-s.getTime())*100).toFixed(e);Object.assign(t,{progress:n,text:"Year Progress",value:`${Math.round(n)}%`,icon:"\u23F3",tip:`${n}%`}),super(t),this.card.onclick=()=>{let d=Math.round(n/(100/a)),p=`Year Progress: ${"".padEnd(d,"\u2593")}${"".padEnd(a-d,"\u2591")} ${n}%`;navigator.clipboard.writeText(p),new Notice(p)}}};o(B,"YearProgress");var w=B;var C=o(async u=>{let t=u.path||dv.current()?.file.path,e=u.separator&&u.separator.length?u.separator:["|",":",","],a=new RegExp(`[${e.join("")}]`,"g"),r=u.sections||[],s=app.vault.getFileByPath(t);if(!s)return[];let i=await app.vault.cachedRead(s),n=[],d="";return i.split(/\r?\n/g).forEach(p=>{let m=p.match(/^#+\s+(.*)/);if(m){d=m[1];return}if(!d||r.length&&!r.includes(d))return;let g=/^\s*([-+*|]|\d+\.) /;if(!g.test(p))return;let h=p.match(/^\s*[-+*|] \[(.)\] /);h&&(p=p.replace(h[0],""));let f=p.replace(g,"").split(a).map(x=>x.trim());h&&f.unshift(h[1]),f.push(d),n.push(f)}),n},"getDataFromFile");var F=class F{constructor(t){this.data=[];this.dataToShow={};(!t.settings||typeof t.settings!="object")&&(t.settings={}),this.config=t,this.loadingCard=new l({width:t.width||3}),this.initialize()}async initialize(){await this.getData(),this.processData(),this.showData(),this.endLoading()}async getData(){let{path:t,separator:e}=this.config;this.data=await C({path:t,sections:Object.keys(this.config.settings),separator:e})}getItemSetting(t,e,a=void 0){return this.config.settings[t][e]||this.config[e]||a}processData(){let t=new Date,e={};this.data.forEach(a=>{let[r,s,...i]=a,n=a[a.length-1];if(this.config.settings[n]){if(e[n]){if(!e[n].perDayComputed){let d=e[n],p=Math.floor((new Date(d.date).getTime()-new Date(r).getTime())/864e5),m=+(new Function("return "+s)()-+new Function("return "+d.money.replace(/\+[\d.]+$/,""))()).toFixed(2);d.perDayComputed=(m/p).toFixed(2)}return}e[n]={date:r,money:s,section:n}}}),Object.values(e).forEach(({date:a,money:r,perDayComputed:s,section:i})=>{let n=Math.floor((t.getTime()-new Date(a).getTime())/864e5),d=r?+new Function("return "+r)():0,p=s||this.config.settings[i].perDay,m=p?Math.floor(d/+p):"\u672A\u77E5",g=m!=="\u672A\u77E5"?+m-n:"\u672A\u77E5",h=g!=="\u672A\u77E5"&&p?(d-+(n*+p)).toFixed(2):"\u672A\u77E5",f=g!=="\u672A\u77E5"?+(Math.max(1-Number(h)/(this.getItemSetting(i,"warningBalcance",0)*3),1-g/(this.config.warningDays||60))*100).toFixed(2):100,x=this.getItemSetting(i,"currency","\u5143");this.dataToShow[i]={className:["card-box-payment"],link:(this.config.path||"")+`#${i}`,progress:f,icon:this.getItemSetting(i,"icon"),text:this.config.settings[i].title||i,width:this.getItemSetting(i,"width",3),position:{before:this.loadingCard.card},tip:`${n} \u5929\u524D ${d} ${x}<br>`+(s?`\u6BCF\u65E5\u6D88\u8017\uFF08\u4F30\u7B97\uFF09\uFF1A${s} ${x}<br>`:"")+`\u9884\u8BA1\u53EF\u7528\uFF1A${g} \u5929<br>\u9884\u4F30\u4F59\u989D\uFF1A${h} ${x}<br>`}})}showData(){Object.keys(this.dataToShow).forEach(t=>{new c(this.dataToShow[t])})}endLoading(){this.loadingCard.remove()}};o(F,"Payment");var b=F;var M=class M{constructor(t){if(!t.items)this.linkHandler(t),new c(t);else{let e=new l({width:t.width||3});t.items.forEach(a=>{a=this.linkHandler({...t,...a,position:{before:e.card}}),new c(a)}),e.remove()}}linkHandler(t){return this.setLink(t),this.setTip(t),this.setStatus(t),t}setLink(t){if(!t.link)return;if(t.fallback&&!app.vault.getFileByPath(t.link)&&(t.link=t.fallback),/^obsidian:\/\//i.test(t.link)){this.setStatus(t,"blue"),this.setIcon(t,"\u2699\uFE0F");return}if(/^https?:\/\//i.test(t.link)){this.setStatus(t,"green"),this.setIcon(t,"\u{1F310}");return}else if(app.vault.getFileByPath(t.link))this.setIcon(t,"\u{1F4C4}");else{this.setStatus(t,"yellow"),this.setIcon(t,"\u{1F4DD}");return}}setStatus(t,e=void 0){!t.status&&e&&(t.status=e),t.status&&(t.progress=100)}setIcon(t,e){t.icon||(t.icon=e)}setTip(t){t.tip||(t.tip=t.link)}};o(M,"Link");var D=M;var I=class I{constructor(t){this.data=[];this.dataToShow=[];(!t.settings||typeof t.settings!="object")&&(t.settings={}),this.config=t,this.loadingCard=new l({width:t.width||3}),this.initialize()}async initialize(){await this.getData(),this.processData(),this.showData(),this.endLoading()}async getData(){let{path:t,separator:e}=this.config;this.data=await C({path:t,sections:Object.keys(this.config.settings),separator:e})}getItemSetting(t,e,a=void 0){return this.config.settings[t][e]||this.config[e]||a}processData(){this.data.forEach(t=>{let[e,a,r,s,i,n,d,p,...m]=t,g=t[t.length-1];if(!this.config.settings||!this.config.settings[g])return;r&&(i&&!s?s=Math.floor((new Date(i).getTime()-new Date(r).getTime())/864e5).toString():!i&&s&&(i=window.moment((new Date(r).getTime()+Number(s)*864e5)/1e3).format("YYYY-MM-DD")));let h={className:["card-box-inventory"],link:(this.config.path||"")+`#${g}`,icon:this.getItemSetting(g,"icon","\u{1F4E6}"),text:a,width:this.getItemSetting(g,"width",3),position:{before:this.loadingCard.card},tip:(r?`\u751F\u4EA7\u65E5\u671F\uFF1A${r}<br>`:"")+(s?`\u4FDD\u8D28\u671F\uFF1A${s}\u5929<br>`:"")+(i?`\u8FC7\u671F\u65E5\u671F\uFF1A${i}<br>`:"")+(n?`\u6570\u91CF\uFF1A${n}${d||""}<br>`:"")+(p?`\u5907\u6CE8\uFF1A${p}<br>`:"")};if(r&&s&&i){let f=Math.floor((new Date().getTime()-new Date(r).getTime())/864e5);h.value=+s-f,h.progress=f/+s*100;let x=this.getItemSetting(g,"warningDays",0);x&&h.value<=x&&(h.status="red+")}this.dataToShow.push(h)})}showData(){this.dataToShow.forEach(t=>{new c(t)})}endLoading(){this.loadingCard.remove()}};o(I,"Inventory");var T=I;var W=class W{constructor(t){if(this.config=t,!this.config.items)new c(this.processData(this.config));else{let e=new l({width:t.width||3});this.config.items.forEach(a=>{a=this.processData(a),new c(a)}),e.remove()}}processData(t){let{date:e,totalDays:a}=t,r=Math.floor((new Date().getTime()-new Date(e).getTime())/864e5),s=Math.abs(r);return t.value=s,a&&(t.progress=+((a-s)/a*100).toFixed(2)),t.icon=t.icon||this.config.icon||" ",t.width=t.width||this.config.width||3,r<0?(t.tip=`\u8DDD\u79BB ${t.text}<br>\uFF08${t.date}\uFF09<br> \u8FD8\u6709 ${s} \u5929`,t.text=`${t.text} >>>`):r>0?(t.tip=` ${t.text}<br>\uFF08${t.date}\uFF09<br> \u5DF2\u7ECF\u8FC7\u53BB\u4E86 ${s} \u5929`,t.text=`<<< ${t.text}`):(t.tip=`\u4ECA\u5929\u5C31\u662F<br>${t.text}<br>\uFF08${t.date}\uFF09`,t.progress=100,t.status="red",t.value=void 0),t}};o(W,"CountDays");var k=W;var j=class j extends c{constructor(t){t.className=["data-shower",...t.className||[]],t.dataName=t.dataName?`${t.dataName}: `:"",super(Object.assign({className:["load-card"],text:t.dataName+"Data is loading..."},t)),this.getData(t)}async getData(t){try{let a=await(await fetch(t.dataSource)).json(),r=t.dataPath.reduce((s,i)=>s[i]||s,a);this.setText(t.dataName+r)}catch(e){console.error(t.dataName+"Error fetching data:",e),this.setText(t.dataName+"Error fetching data")}}};o(j,"DataShower");var v=j;var H=class H extends c{constructor(t){t.className=["data-shower",...t.className||[]],t.dataName=t.dataName?`${t.dataName}: `:"",t.queryType=t.queryType==="key"?"key":"total",t.dataSource||(t.dataSource=t.queryType==="key"?"https://openrouter.ai/api/v1/auth/key":"https://openrouter.ai/api/v1/credits"),super(Object.assign({className:["load-card"],text:t.dataName+"Data is loading..."},t)),this.getData(t)}async getData(t){try{let a=await(await fetch(t.dataSource,{method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer "+t.key}})).json(),r=+new Function("return "+t.price)(),s=o((i,n=5)=>(i*r).toFixed(n),"toCNY");if(t.queryType==="total"){let i=a.data.total_usage,n=a.data.total_credits,d=n-i;this.setText(t.dataName+String(d.toFixed(3))),this.setProgress(i/n),this.setValue((i/n).toFixed(2)),this.setTip(`\u5DF2\u4F7F\u7528\uFF1A$ ${i} / \xA5 ${s(i)}<br>\u603B\u989D\uFF1A$ ${n} / \xA5 ${s(n)}<br>\u5269\u4F59\uFF1A$ ${d.toFixed(5)} / \xA5 ${s(d)}`)}else{let i=a.data.usage;this.setText(t.dataName+String(i.toFixed(3)));let n="Key: "+t.key.slice(-3);this.setTip(`\u5DF2\u4F7F\u7528\uFF1A$ ${i} / \xA5 ${s(i)}<br>key: ${n}`)}}catch(e){console.error(t.dataName+"Error fetching data:",e),this.setText(t.dataName+"Error fetching data")}}};o(H,"OpenRouterShower");var $=H;var P={Header:y,YearProgress:w,Payment:b,Link:D,Inventory:T,CountDays:k,DataShower:v,OpenRouterShower:$},q=class q{constructor(t){if(t.type=t.type||"no type",!Object.keys(P).includes(t.type)){new P.Header({text:`\u672A\u627E\u5230\u6302\u4EF6 ${t.type}`});return}new P[t.type](t)}};o(q,"Widget");var S=q;dv.container.classList.add("homepage-container");input.forEach(u=>{new S(u)});})();
